name: Test Environment Variables

on:
  workflow_dispatch:
  push:
    branches: [main, master, develop]

jobs:
  test-env:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug environment information
        run: |
          echo "=== Environment Debug Info ==="
          ENV_NAME="${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}"
          echo "Environment name: $ENV_NAME"
          echo "GitHub ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "=============================="

      - name: Decode base64 environment variables
        run: |
          # Check if secret exists
          SECRET_VALUE="${{ secrets.DEPLOYMENT_POC_ENV_VARS }}"
          
          if [ -z "$SECRET_VALUE" ]; then
            echo "ERROR: DEPLOYMENT_POC_ENV_VARS secret is not set or empty"
            echo ""
            ENV_NAME="${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}"
            echo "Troubleshooting steps:"
            echo "1. Go to: Repository Settings → Environments"
            echo "2. Select the environment: $ENV_NAME"
            echo "3. Add a secret named exactly: DEPLOYMENT_POC_ENV_VARS"
            echo "4. Value should be base64-encoded JSON like:"
            echo "   {\"PORT\":\"3000\",\"NODE_ENV\":\"development\",\"API_KEY\":\"your-key\"}"
            echo ""
            echo "To encode your JSON:"
            echo "  echo -n '{\"PORT\":\"3000\",\"NODE_ENV\":\"development\",\"API_KEY\":\"your-key\"}' | base64"
            exit 1
          fi
          
          echo "✅ Secret found! Length: $(echo -n "$SECRET_VALUE" | wc -c) characters"
          
          # Decode the base64 encoded JSON
          set +e
          ENV_VARS_JSON=$(echo "$SECRET_VALUE" | base64 -d 2>&1)
          DECODE_EXIT=$?
          set -e
          
          if [ $DECODE_EXIT -ne 0 ]; then
            echo "ERROR: Failed to decode base64"
            echo "$ENV_VARS_JSON"
            exit 1
          fi
          
          # Display decoded JSON structure (for debugging)
          echo "=== Decoded JSON Structure ==="
          echo "$ENV_VARS_JSON"
          echo "=============================="
          
          # Validate JSON
          if ! echo "$ENV_VARS_JSON" | jq empty 2>/dev/null; then
            echo "ERROR: Decoded value is not valid JSON"
            exit 1
          fi
          
          # Extract each variable from JSON and set as environment variable
          PORT_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.PORT // empty')
          NODE_ENV_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.NODE_ENV // empty')
          API_KEY_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.API_KEY // empty')
          
          echo "PORT_VAL: $PORT_VAL"
          echo "NODE_ENV_VAL: $NODE_ENV_VAL"
          echo "API_KEY_VAL: ${API_KEY_VAL:0:4}... (masked)"
          
          # Set environment variables
          echo "PORT=$PORT_VAL" >> $GITHUB_ENV
          echo "NODE_ENV=$NODE_ENV_VAL" >> $GITHUB_ENV
          echo "API_KEY=$API_KEY_VAL" >> $GITHUB_ENV

      - name: Display decoded values (masked for security)
        run: |
          echo "=== Decoded Environment Variables ==="
          echo "PORT: $PORT"
          echo "NODE_ENV: $NODE_ENV"
          echo "API_KEY: ${API_KEY:0:4}... (masked)"
          echo "================================"
          
          # Verify they are decoded correctly
          if [ -z "$PORT" ]; then
            echo "ERROR: PORT is empty"
            exit 1
          fi
          
          if [ -z "$NODE_ENV" ]; then
            echo "ERROR: NODE_ENV is empty"
            exit 1
          fi
          
          if [ -z "$API_KEY" ]; then
            echo "ERROR: API_KEY is empty"
            exit 1
          fi
          
          echo "✅ All environment variables decoded successfully!"

      - name: Test with Express app
        run: |
          npm ci
          timeout 3 node server.js &
          sleep 2
          curl -f http://localhost:$PORT/health || exit 1
          echo "✅ Server started successfully with decoded env vars!"

