name: Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Decode base64 environment variables
        run: |
          # Check if secret exists
          if [ -z "${{ secrets.DEPLOYMENT_POC_ENV_VARS }}" ]; then
            echo "ERROR: DEPLOYMENT_POC_ENV_VARS secret is not set or empty"
            exit 1
          fi

          SECRET_VALUE="${{ secrets.DEPLOYMENT_POC_ENV_VARS }}"
          echo "Secret exists, length: $(echo -n "$SECRET_VALUE" | wc -c) characters"

          # Trim whitespace from the base64 string
          SECRET_VALUE=$(echo -n "$SECRET_VALUE" | tr -d '[:space:]')

          # Decode the base64 encoded JSON (using -i to ignore garbage/whitespace)
          set +e
          ENV_VARS_JSON=$(echo -n "$SECRET_VALUE" | base64 -di 2>&1)
          DECODE_EXIT=$?
          set -e

          if [ $DECODE_EXIT -ne 0 ]; then
            echo "ERROR: Failed to decode base64"
            echo "Attempting alternative decoding method..."
            # Try without -i flag
            ENV_VARS_JSON=$(echo -n "$SECRET_VALUE" | base64 -d 2>&1)
            if [ $? -ne 0 ]; then
              echo "Base64 decode error: $ENV_VARS_JSON"
              exit 1
            fi
          fi

          # Clean up the JSON (remove any trailing newlines/whitespace)
          ENV_VARS_JSON=$(echo -n "$ENV_VARS_JSON" | tr -d '\n\r')

          # Display what was decoded (for debugging)
          echo "=== Decoded JSON Structure ==="
          echo "$ENV_VARS_JSON"
          echo "=============================="

          # Validate JSON
          if ! echo "$ENV_VARS_JSON" | jq empty 2>/dev/null; then
            echo "ERROR: Decoded value is not valid JSON"
            exit 1
          fi

          # Extract each variable from JSON and set as environment variable
          PORT_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.PORT // empty')
          NODE_ENV_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.NODE_ENV // empty')
          API_KEY_VAL=$(echo "$ENV_VARS_JSON" | jq -r '.API_KEY // empty')

          echo "PORT_VAL: $PORT_VAL"
          echo "NODE_ENV_VAL: $NODE_ENV_VAL"
          echo "API_KEY_VAL: ${API_KEY_VAL:0:4}... (masked)"

          # Set environment variables
          echo "PORT=$PORT_VAL" >> $GITHUB_ENV
          echo "NODE_ENV=$NODE_ENV_VAL" >> $GITHUB_ENV
          echo "API_KEY=$API_KEY_VAL" >> $GITHUB_ENV

      - name: Display decoded environment variables (masked)
        run: |
          echo "PORT is set: $([ -n "$PORT" ] && echo 'yes' || echo 'no')"
          echo "NODE_ENV is set: $([ -n "$NODE_ENV" ] && echo 'yes' || echo 'no')"
          echo "API_KEY is set: $([ -n "$API_KEY" ] && echo 'yes' || echo 'no')"
          echo "API_KEY first 4 chars: ${API_KEY:0:4}..."

      - name: Install dependencies
        run: npm ci

      - name: Build check
        run: |
          echo "Build check passed"
          # Add your build commands here if needed

      - name: Deploy
        run: |
          echo "Deploy to your platform here"
          echo "Using PORT: $PORT"
          echo "Using NODE_ENV: $NODE_ENV"
          # Example: Deploy to Heroku, AWS, Vercel, etc.
          # Add your deployment commands here
